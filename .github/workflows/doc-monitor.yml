name: NTT SCP Document Monitor

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥åˆå‰9æ™‚(JST) = UTC 0æ™‚
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      test_mode:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ€ãƒŸãƒ¼å·®åˆ†ã§é€šçŸ¥ãƒ†ã‚¹ãƒˆï¼‰'
        required: false
        type: boolean
        default: false

jobs:
  check-document:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆå·®åˆ†æ¯”è¼ƒã®ãŸã‚ï¼‰

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 html5lib

      - name: Fetch document
        id: fetch
        if: ${{ !inputs.test_mode }}
        run: |
          DATE=$(date +%Y%m%d)
          echo "date=$DATE" >> $GITHUB_OUTPUT

          # Fetch HTML with proper encoding
          python scripts/fetch_doc.py \
            "https://cloud.nttsmc.com/doc/scp/scp_type-v_spec_resource-pool/" \
            "snapshots/${DATE}.html"

      - name: Set date for test mode
        id: test_date
        if: ${{ inputs.test_mode }}
        run: |
          DATE=$(date +%Y%m%d)
          echo "date=${DATE}" >> $GITHUB_OUTPUT

      - name: Create test diff
        if: ${{ inputs.test_mode }}
        run: |
          echo "ğŸ§ª Test mode: Creating dummy diff files"
          python scripts/create_test_diff.py

      - name: Check for changes
        id: diff
        if: ${{ !inputs.test_mode }}
        run: |
          python scripts/check_diff.py

      - name: Set test mode output
        if: ${{ inputs.test_mode }}
        run: |
          echo "changed=true" >> $GITHUB_OUTPUT

      - name: Create Issue if changed
        if: steps.diff.outputs.changed == 'true' || inputs.test_mode
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const diffContent = fs.readFileSync('diff_summary.txt', 'utf8');
            const diffDetails = fs.readFileSync('diff_details.txt', 'utf8');

            const testPrefix = context.payload.inputs?.test_mode ? '[ãƒ†ã‚¹ãƒˆ] ' : '';
            const date = '${{ steps.fetch.outputs.date || steps.test_date.outputs.date }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${testPrefix}ğŸš¨ NTT SCPä»•æ§˜æ›¸ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ (${date})`,
              body: `## å¤‰æ›´æ¤œçŸ¥\n\n${diffContent}\n\n<details>\n<summary>è©³ç´°ãªå·®åˆ†</summary>\n\n\`\`\`diff\n${diffDetails}\n\`\`\`\n\n</details>\n\n[æœ€æ–°ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/snapshots/${date}.html)`,
              labels: ['documentation', 'auto-detected']
            });

      - name: Generate visual diff viewer
        if: steps.diff.outputs.changed == 'true' || inputs.test_mode
        run: |
          python scripts/generate_diff_viewer.py

      - name: Send Discord notification
        if: steps.diff.outputs.changed == 'true' || inputs.test_mode
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "âš ï¸  Discord webhook URL not set. Skipping Discord notification."
            exit 0
          fi

          # Add visual diff viewer link to notification
          VIEWER_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/diffs/${{ steps.fetch.outputs.date || steps.test_date.outputs.date }}.html"
          echo "ğŸ”— Visual Diff Viewer: $VIEWER_URL"

          python scripts/notify_discord.py \
            "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            "${{ steps.fetch.outputs.date || steps.test_date.outputs.date }}" \
            "${{ github.server_url }}/${{ github.repository }}"

      - name: Commit and push snapshot
        if: steps.diff.outputs.changed == 'true' && !inputs.test_mode
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add snapshots/
          git add docs/
          git add diff_summary.txt diff_details.txt
          git commit -m "ğŸ“¸ Add snapshot and visual diff viewer ${{ steps.fetch.outputs.date }}"
          git push

      - name: No changes detected
        if: steps.diff.outputs.changed != 'true' && !inputs.test_mode
        run: |
          echo "âœ… No changes detected. Document is unchanged."
