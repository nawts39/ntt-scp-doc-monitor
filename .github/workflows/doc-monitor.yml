name: NTT SCP Document Monitor

on:
  schedule:
    - cron: '0 0 * * *'  # ÊØéÊó•ÂçàÂâç9ÊôÇ(JST) = UTC 0ÊôÇ
  workflow_dispatch:  # ÊâãÂãïÂÆüË°å„ÇÇÂèØËÉΩ
    inputs:
      test_mode:
        description: '„ÉÜ„Çπ„Éà„É¢„Éº„ÉâÔºà„ÉÄ„Éü„ÉºÂ∑ÆÂàÜ„ÅßÈÄöÁü•„ÉÜ„Çπ„ÉàÔºâ'
        required: false
        type: boolean
        default: false

jobs:
  check-document:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ÂÖ®Â±•Ê≠¥„ÇíÂèñÂæóÔºàÂ∑ÆÂàÜÊØîËºÉ„ÅÆ„Åü„ÇÅÔºâ

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 html5lib

      - name: Fetch document
        id: fetch
        if: ${{ !inputs.test_mode }}
        run: |
          DATE=$(date +%Y%m%d)
          echo "date=$DATE" >> $GITHUB_OUTPUT

          # Fetch HTML with proper encoding
          python scripts/fetch_doc.py \
            "https://cloud.nttsmc.com/doc/scp/scp_type-v_spec_resource-pool/" \
            "snapshots/${DATE}.html"

      - name: Set date for test mode
        id: test_date
        if: ${{ inputs.test_mode }}
        run: |
          DATE=$(date +%Y%m%d)
          echo "date=${DATE}" >> $GITHUB_OUTPUT

      - name: Create test snapshots and diff
        if: ${{ inputs.test_mode }}
        run: |
          echo "üß™ Test mode: Creating test snapshots with visual differences"
          python scripts/create_test_snapshots.py
          python scripts/check_diff.py
          python scripts/create_test_diff.py

      - name: Check for changes
        id: diff
        if: ${{ !inputs.test_mode }}
        run: |
          python scripts/check_diff.py

      - name: Set test mode output
        if: ${{ inputs.test_mode }}
        run: |
          echo "changed=true" >> $GITHUB_OUTPUT

      - name: Create Issue if changed
        if: steps.diff.outputs.changed == 'true' || inputs.test_mode
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const diffContent = fs.readFileSync('diff_summary.txt', 'utf8');
            const diffDetails = fs.readFileSync('diff_details.txt', 'utf8');

            const testPrefix = context.payload.inputs?.test_mode ? '[„ÉÜ„Çπ„Éà] ' : '';
            const date = '${{ steps.fetch.outputs.date || steps.test_date.outputs.date }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${testPrefix}üö® NTT SCP‰ªïÊßòÊõ∏„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü (${date})`,
              body: `## Â§âÊõ¥Ê§úÁü•\n\n${diffContent}\n\n<details>\n<summary>Ë©≥Á¥∞„Å™Â∑ÆÂàÜ</summary>\n\n\`\`\`diff\n${diffDetails}\n\`\`\`\n\n</details>\n\n[ÊúÄÊñ∞„Çπ„Éä„ÉÉ„Éó„Ç∑„Éß„ÉÉ„Éà](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/snapshots/${date}.html)`,
              labels: ['documentation', 'auto-detected']
            });

      - name: Generate visual diff viewer
        if: steps.diff.outputs.changed == 'true' || inputs.test_mode
        run: |
          python scripts/generate_diff_viewer.py

      - name: Send Discord notification
        if: steps.diff.outputs.changed == 'true' || inputs.test_mode
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "‚ö†Ô∏è  Discord webhook URL not set. Skipping Discord notification."
            exit 0
          fi

          # Add visual diff viewer link to notification
          VIEWER_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/diffs/${{ steps.fetch.outputs.date || steps.test_date.outputs.date }}.html"
          echo "üîó Visual Diff Viewer: $VIEWER_URL"

          python scripts/notify_discord.py \
            "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            "${{ steps.fetch.outputs.date || steps.test_date.outputs.date }}" \
            "${{ github.server_url }}/${{ github.repository }}"

      - name: Send Email notification
        if: steps.diff.outputs.changed == 'true' || inputs.test_mode
        env:
          GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: |
          if [ -z "$GMAIL_ADDRESS" ] || [ -z "$GMAIL_APP_PASSWORD" ] || [ -z "$EMAIL_TO" ]; then
            echo "‚ö†Ô∏è  Email credentials not set. Skipping email notification."
            exit 0
          fi

          python scripts/notify_email.py \
            "${{ secrets.GMAIL_ADDRESS }}" \
            "${{ secrets.GMAIL_APP_PASSWORD }}" \
            "${{ secrets.EMAIL_TO }}" \
            "${{ steps.fetch.outputs.date || steps.test_date.outputs.date }}" \
            "${{ github.server_url }}/${{ github.repository }}"

      - name: Commit and push snapshot
        if: steps.diff.outputs.changed == 'true' || inputs.test_mode
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add snapshots/
          git add docs/

          COMMIT_MSG="üì∏ Add snapshot and visual diff viewer ${{ steps.fetch.outputs.date || steps.test_date.outputs.date }}"
          if [ "${{ inputs.test_mode }}" = "true" ]; then
            COMMIT_MSG="[„ÉÜ„Çπ„Éà] $COMMIT_MSG"
          fi

          git commit -m "$COMMIT_MSG" || echo "Nothing to commit"
          git push

      - name: No changes detected
        if: steps.diff.outputs.changed != 'true' && !inputs.test_mode
        run: |
          echo "‚úÖ No changes detected. Document is unchanged."
