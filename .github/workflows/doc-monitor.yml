name: NTT SCP Document Monitor

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥åˆå‰9æ™‚(JST) = UTC 0æ™‚
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  check-document:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆå·®åˆ†æ¯”è¼ƒã®ãŸã‚ï¼‰

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 html5lib

      - name: Fetch document
        id: fetch
        run: |
          DATE=$(date +%Y%m%d)
          echo "date=$DATE" >> $GITHUB_OUTPUT

          # Fetch HTML with proper encoding
          python scripts/fetch_doc.py \
            "https://cloud.nttsmc.com/doc/scp/scp_type-v_spec_resource-pool/" \
            "snapshots/${DATE}.html"

      - name: Check for changes
        id: diff
        run: |
          python scripts/check_diff.py

      - name: Create Issue if changed
        if: steps.diff.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const diffContent = fs.readFileSync('diff_summary.txt', 'utf8');
            const diffDetails = fs.readFileSync('diff_details.txt', 'utf8');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ NTT SCPä»•æ§˜æ›¸ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ (${process.env.DATE})`,
              body: `## å¤‰æ›´æ¤œçŸ¥\n\n${diffContent}\n\n<details>\n<summary>è©³ç´°ãªå·®åˆ†</summary>\n\n\`\`\`diff\n${diffDetails}\n\`\`\`\n\n</details>\n\n[æœ€æ–°ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/snapshots/${process.env.DATE}.html)`,
              labels: ['documentation', 'auto-detected']
            });
        env:
          DATE: ${{ steps.fetch.outputs.date }}

      - name: Commit and push snapshot
        if: steps.diff.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add snapshots/
          git add diff_summary.txt diff_details.txt
          git commit -m "ğŸ“¸ Add snapshot ${{ steps.fetch.outputs.date }}"
          git push

      - name: No changes detected
        if: steps.diff.outputs.changed != 'true'
        run: |
          echo "âœ… No changes detected. Document is unchanged."
